name: Smoke Tests CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  actions: read
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Install Playwright dependencies
      run: |
        mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install --with-deps" || true
        echo "Playwright installation completed (or skipped if failed)"
        
    - name: Run smoke tests
      run: |
        mvn test -Dtest="HealthCheckTest,SwaggerUiSmokeTest" \
          -Dmaven.test.failure.ignore=true \
          -Dallure.results.directory=target/allure-results \
          -DfailIfNoTests=false
          
    - name: Generate Surefire HTML report
      if: always()
      run: mvn surefire-report:report-only site -DgenerateReports=false
      
    - name: Generate Allure Report
      if: always()
      run: mvn allure:report
      
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: smoke-test-results
        path: |
          target/surefire-reports/
          target/site/
          target/allure-report/
        retention-days: 30
        
    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-smoke
        path: target/allure-results/
        retention-days: 30
        
    - name: Publish Test Report
      if: always()
      uses: dorny/test-reporter@v1
      continue-on-error: true
      with:
        name: Smoke Tests Report
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: false
        
    - name: Comment PR with Test Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'target/surefire-reports';
          if (fs.existsSync(path)) {
            const files = fs.readdirSync(path).filter(f => f.endsWith('.xml'));
            let comment = '## ðŸ§ª Smoke Tests Results\n\n';
            comment += `- **Tests Run**: ${files.length} test classes\n`;
            comment += `- **Status**: ${context.payload.workflow_run?.conclusion || 'completed'}\n`;
            comment += `- **Reports**: [View Detailed Reports in Artifacts](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }